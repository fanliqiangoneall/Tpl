<extend name="HJZF2_Z:basein" />
<block name="content">
<php>
$parent_path_str=','.$prolist['pcid'].','.$prolist['parent_path'].','.$prolist['parent_path'];
if(strstr($parent_path_str,",256,")){
	$htmltype="Product";
    $typeid="256";
}else{
	$htmltype="Case";
    $typeid="257";
}
</php>

<Include file="./Tpl/HJZF2_Z/HJZF2_Z-product_categories-lingtong/inner/shopping_car.html"/> 

<div class="lingtong_loading" id="lingtong_loading">
	<img src="__TMPL__HJZF2_Z/inner/img/Loading.svg" alt="">
</div>
<!--banner-->
<div class="{$htmltype}">
<if condition="$prolist['banner'] neq ''">
    <div id="HJZF_Z__wrapper">
        <div class="HJZF_Z__innerBanner HJZF_Z__innerBanner2">
        	<div class="in_banner"><img src="{:getimgurl($prolist['banner'])}" /></div>
        </div>
    </div>
    <elseif condition="$inner_data[0]" />
    <div id="HJZF_Z__wrapper">
        <div class="HJZF_Z__innerBanner HJZF_Z__innerBanner2">
        	<div class="in_banner"><img src="{:getindeximgurl($inner_data[0])}" /></div>
        </div>
    </div>
</if>
<!--banner-->
<style>

.Product .lingtong_cate[pcid="257"]{
	display:none;
}
.Case .lingtong_cate[pcid="256"]{
	display:none;
}
/*加载*/
.lingtong_loading{
	position: fixed;
	left: 0;
	right: 0;
	bottom: 0;
	top: 0;
	width: 100%;
	height: 100%;
	z-index: 99999;
	background: rgba(0,0,0,.2);
	display: flex;
	justify-content: center;
	align-items: center;
	width: 100%;
	min-height: 200px;
}
.lingtong_loading img{
	width: 80px;
	animation: zuan 2.5s ease-in-out infinite;
}
@keyframes zuan{
	from{
		transform: rotate(0);
	}
	to{
		transform: rotate(360deg);
	}
}
.product_categories_content{ display:flex; justify-content:space-between; box-sizing:border-box;}
.HJZF2_Z-product_categories-lingtong-left{
	flex:0 0 23%;
}
.HJZF2_Z-product_categories-lingtong-right{
	flex:0 9 75%;
	margin-left:2%;
}
/*左边*/

.current{ 
	color:#{$color};
}	
/*右边内容*/
.page{ margin-top:30px; text-align:center; margin-bottom:30px;}

.page a,.page span{padding:8px 15px; border:1px solid #d1d1d1; margin-right:10px; box-shadow:0 0 6px #ccc;}
.attr_checkbox{ display:none;}
.attr_switch_row{ display:flex; justify-content:space-between; align-items:center; margin-top:70px;}
.attr_tip{ font-size:20px; color:#333333;}
.Collapse_filter_switch{ background:#a6a6a6; padding:10px; color:#ffffff; display:flex; align-items:center; cursor:pointer;}
.attr_checkbox_label{ margin:0 auto;background:url(__TMPL__HJZF2_Z/HJZF2_Z-product_categories-lingtong/more_open.png) no-repeat center center !important; width:20px; height:20px; display:inline-block;}
input[type="checkbox"]:checked + .attr_checkbox_label{
background:url(__TMPL__HJZF2_Z/HJZF2_Z-product_categories-lingtong/more_close.png) no-repeat center center !important;
}
.more{ display:flex; align-items:center;}
.Collapse_filter_switch .txt{ margin-right:35px;}
.attrs_row{ border:1px solid #b5b5b5; background:#f2f2f2; padding:30px; margin-top:15px;}
.rest,.attr_ok{ color:#fff; display:inline-block; padding:5px 30px; border-radius:5px; cursor:pointer; background:#{$color}; }
.attrs_row li{ padding:15px 0px; border-bottom:1px dashed #d6d6d6; display:flex;}
.attrs_row_attr,.attr{ display:flex;}
.attrs_row_attr{ flex-wrap:wrap; height:30px; overflow:hidden;}
.attr{ margin-right:25px;}
.attrs_row_name{ font-size:20px; color:#000; width:200px;}
.attr .custorm_checkbox .advice{ margin-right:5px;}
.rest{ margin-right:20px;}
.submit_bar{ margin-top:35px;}
.product_show{ display:flex; flex-wrap:wrap; justify-content:space-between; margin-bottom:80px;}
.product_box{box-shadow: 0 0 30px rgba(0, 0, 0, 0.05); margin-top:80px; flex:0 0 32%; position:relative;}
.product_box a{}
.product_box img{ max-width:100%;}
.product_name{ text-align:center; padding: 12px 12px 12px;}
.product_des{ margin: 12px 12px 54px 0px; padding:0 40px; text-overflow: -o-ellipsis-lastline;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;}
.tool_more{ display:flex; justify-content:center; align-items:center;}
.tool_more .attr_checkbox_label{ margin:5px;background:url(__TMPL__HJZF2_Z/HJZF2_Z-product_categories-lingtong/attr_close.png) no-repeat center center !important; width:20px; height:20px; display:inline-block;}
.tool_more input[type="checkbox"]:checked + .attr_checkbox_label{
background:url(__TMPL__HJZF2_Z/HJZF2_Z-product_categories-lingtong/attr_open.png) no-repeat center center !important;
}
.no_content{ margin:40px 0;}

.shop_car_tool{display:flex; align-items:center; justify-content:center; position:absolute; bottom:-22px; cursor:pointer; width:100%;}
.add_shop_car_btn{ position:relative; min-width:50%; background:#a6a6a6; border-radius:5px; padding:10px 30px; color:#fff; display:flex; justify-content:center; white-space:nowrap;}
.add_shop_car_btn:hover{ background:#{$color}}
.shopping_car_btn{ margin-right:10px;}
.attr_pro_name{ font-size:16px; font-weight:normal;}
.tool_more{ display:none;}
.page_click{ cursor:pointer;}
.product_img{ position:relative;}

@media(max-width: 1200px) {
	.attrs_row li{ flex-direction:column;}
	.tool_more{justify-content:flex-start; display:none;}
}
@media(max-width: 750px) {
	.product_categories_content{ flex-direction:column;}
	.attr_switch_row {
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    margin-top: 70px;
    flex-direction: column;
}
.product_box{ flex:0 0 100%;}

}

</style>


<div class="HJZF2_Z-product_categories-lingtong">
	<nav class="inner_daohang"><a href="{:U('/')}"><span class="navmap"></span>{:__('Your location:')}{:__('Home')}</a> &nbsp; <i class="fa fa-angle-right"></i>
            <a >{$htmltype}</a> &nbsp; <i class="fa fa-angle-right"></i>
            <span class="current">{$prolist['class_name']}</span></nav>
    <div class="product_categories_content">
        <!--左边-->
        <Include file="./Tpl/HJZF2_Z/HJZF2_Z-product_categories-lingtong/inner/left.html" />
        <!--左边-->
        <div class="HJZF2_Z-product_categories-lingtong-right">
        	<div class="attr_switch_row">
            	<div class="attr_tip">Friendly reminder: select the products you need according to the conditions!</div>
                <div class="Collapse_filter_switch"><span class="txt">Collapse filter</span><span class="more"><input class="attr_checkbox" type="checkbox"><label for="attr_checkbox" class="attr_checkbox_label"></label></span></div>
            </div>
            <div class="attrs_row">
            	<ul>
                <!--一级属性分类-->
                <volist name="all_search_cates" id="search_cate">
                    <li>
                    <!--二级属性分类-->
                    	<div class="attrs_row_name">{$search_cate['class_name']}</div>
                        <div class="attrs_row_attr">
                        	<volist name="search_cate['attrs']" id="attr">
                            <div class="attr">
                                <div class="custorm_checkbox">
                                    <input value="{$attr['pid']}" id="cates_checkbox_attr{$attr['pid']}" class="cates_checkbox" type="checkbox">
                                    <label for="cates_checkbox_attr{$attr['pid']}" class="advice"></label>  
                                </div>
                                <label for="cates_checkbox_attr{$attr['pid']}" class="attr_pro_name">{$attr['pro_name']}</label>  
                            </div>
                            </volist>  
                                                            					                        	
                        </div>
                        <div class="tool_more">more<span class="more"><input class="attr_checkbox" type="checkbox"><label for="attr_checkbox" class="attr_checkbox_label"></label></span></div>
                    <!--二级属性分类-->	
                    </li>                
                </volist>
  					<!--一级属性分类-->
                </ul>
                <div class="submit_bar">
                    <div class="attr_ok">OK</div>
                    <div class="rest">REST</div>
                </div>                
            </div>

        	<div class="page">{$page}</div>    
            <div class="product_show">
            <php>
                $no_empty = '<span class="no_content">'.__('No Content').'...</span>';
            </php>           
            <volist empty="$no_empty" name="pro" id="pro" key="k">
				
                    <div class="product_box">
                    	<a href="{:U('/Product','','')}/{:getproname($pro['pid'])}">
                            <div class="product_img">
                                <img src="{:getmainimgurl($pro['main_img'])}" <if condition="$pro['proalt'] neq ''">alt="{$pro['proalt']}"
                                <else/>alt="{$pro['pro_name']}"</if> />
                            </div>
                            <div class="product_name">{$pro['pro_name']}</div>
                            <div class="product_des">{:subtxt($pro['pro_description'],80)}</div>
                        </a>
                        <div class="shop_car_tool">
                             <div class="add_shop_car_btn" pid="{$pro['pid']}" pro_img="{:getmainimgurl($pro['main_img'])}" pro_name="{$pro['pro_name']}">
                                <div class="shopping_car_btn">
                                    <img src="__TMPL__HJZF2_Z/HJZF2_Z-product_categories-lingtong/car.png" alt="">
                                </div> 
                                Add to cart                   
                            </div>                   
                        </div>
    
                    </div>
                
          
            </volist>  
            <if condition="count($pro)%3 eq 2">
            	<div class="product_box" style=" width:0px; height:0px;">
                </div>
            </if>          
                                                      
            </div>
            <div class="page">{$page}</div>
            
        </div>
    </div>
</div>
</div>

</block>

<block name="footer_js">
<script>
require(['jquery'],function($){
	var page=1;
	var limit=15;
	var url="{:U('/index.php/SearchApi/get_all_search_product','','')}";
	/*初始化加载动画*/
	var loadingtimsers = null;
	clearTimeout(loadingtimsers);
	loadingtimsers = setTimeout(function () {
		$('.lingtong_loading').fadeOut(300);
	}, 20000);
/*获取url参数*/
function getQueryVariable(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}	

	window.onload = function () {
		clearTimeout(loadingtimsers);
		var cates_checkbox_attr=getQueryVariable("attr");
		console.log("cates_checkbox_attr",cates_checkbox_attr);
		if(cates_checkbox_attr){
			$("#cates_checkbox_attr"+cates_checkbox_attr).trigger("click");
		}
		$('.lingtong_loading').fadeOut(300);
	}
	/*初始化加载动画*/
	

$(document).on("click",".Collapse_filter_switch",function(){
	var that=$(this).find('.attr_checkbox');
	if($(that).prop("checked")){
		$(that).prop("checked",false);
	}else{
		$(that).prop("checked",true);
	}	
	$(".attrs_row").toggle("fast");
}).on("click",".attr_ok",function(){
	//属性确定按钮
	var attrs=[];
	$(".attrs_row_attr input:checked").each(function(index, element) {
		attrs.push($(this).val()); 
	});
	if(attrs){
		//search 条件
		var search_str=attrs.join(",");
		console.log("search_str",search_str);
	}
	var classid="";
	classid=$(".lingtong_cate input:checked").eq("0").val();
	console.log("classid",classid);
	var params={classid:classid,attrs:search_str,page:page,limit:limit};
	search_ajax(url,"", params,1).done(function(data){search_ajax_done(data)});

}).on("click",".rest",function(){
	$(".attrs_row_attr input:checked").prop("checked",false);
}).on("click",".tool_more",function(){
	//属性more按钮
	var that=$(this).find('.attr_checkbox');
	if($(that).prop("checked")){
		$(that).prop("checked",false);
		$(this).parent().find('.attrs_row_attr').css("height",'30px');

	}else{
		$(that).prop("checked",true);
		$(this).parent().find('.attrs_row_attr').css("height",'auto');
	}	
	
}).on("click",".page_click",function(){
	page=$(this).html();
	var attrs=[];
	$(".attrs_row_attr input:checked").each(function(index, element) {
		attrs.push($(this).val()); 
	});
	if(attrs){
		//search 条件
		var search_str=attrs.join(",");
		console.log("search_str",search_str);
	}	
	var classid="";
	classid=$(".lingtong_cate input:checked").eq("0").val();	
	var params={classid:classid,attrs:search_str,page:page,limit:limit};
	search_ajax(url,"", params,1).done(function(data){search_ajax_done(data)});	
})

//计算more出现的时机
var attrs_row_attr_total_width=$(".attrs_row_attr").eq(0).innerWidth();
console.log("attrs_row_attr_total_width",attrs_row_attr_total_width);
if(attrs_row_attr_total_width){
	$(".attrs_row_attr").each(function(index, element) {
		 var attr_with=0;
        $(this).find('.attr').each(function(index, element) {
            attr_with=attr_with+$(this).outerWidth(true);
			console.log("attr_with",attr_with);
        });
		if(attr_with>attrs_row_attr_total_width){
			$(this).parent().find(".tool_more").css("display","flex");	
		}else{
			console.log("关闭");
			$(this).parent().find(".tool_more").hide();
		}
    });	
}


 function search_ajax(url, type, params, load) {
	var deferred = $.Deferred();
	$.ajax({
	  url: url,
	  type: type || "get",
	  data: params || {},
	  dataType: "json",
	  beforeSend: function () {
		if (load) {
			$('.lingtong_loading').fadeIn(300);
		}
	  },
	  success: function (data) {
		
		if (data.status == 1) {
		  // 业务正常
		  deferred.resolve(data);
		  //console.log("请求数据", data.data);
		} else {
		  // 业务异常
//		  layer.msg(data.info, {
//			icon: 7,
//			time: 2000
//		  });
		  deferred.reject("zq.ajax warn: " + data.info);
		}
	  },
	  complete: function () {
		if (load) {
			var timer;
			clearTimeout(timer);
			timer = setTimeout(function (){
				$('.lingtong_loading').fadeOut(300);
			}, 500);
		}
	  },
	  error: function () {
		if (load) {
			var timer;
			clearTimeout(timer);
			timer = setTimeout(function (){
				$('.lingtong_loading').fadeOut(300);
			}, 500);
		}
//		layer.msg("服务器错误", {
//		  icon: 2,
//		  time: 2000
//		});
		deferred.reject("ajax error: 服务器错误");
	  }
	});
	return deferred.promise();

};



function search_ajax_done(data){
	var dom_html='';
	if(data.data){
		$.each(data.data,function(i,v){
		dom_html=dom_html+
		'<div class="product_box">'+
		'<a href="'+v.pro_url+'">'+
			'<img src="'+v.pro_img+'" alt="'+v.pro_name+'">'+
			'<div class="product_name">'+v.pro_name+'</div>'+
			'<div class="product_des">'+v.pro_description+'</div>'+
		'</a>'+	
			'<div class="shop_car_tool">'+
				'<div class="add_shop_car_btn" pid="'+v.pid+'" pro_img="'+v.pro_img+'" pro_name="'+v.pro_name+'">'+
					'<div class="shopping_car_btn">'+
					'<img src="__TMPL__HJZF2_Z/HJZF2_Z-product_categories-lingtong/car.png" alt="">'+
					'</div> '+
				'Add to cart'+                   
				'</div>'+                   
			'</div>'+
			'</div>';
		})
		if(data.data.length%3==2){
			dom_html=dom_html+'<div class="product_box" style="width:0px; height:0px;">'+
			'</div>';
		}
	}else{
		dom_html='<span class="no_content">'+"{:__('No Content')}"+'...</span>';
	}
	$(".product_show").html(dom_html);
	$('.page').html('');
	var total = data.info.total;
	if(total > limit) {
		console.log(total);
		var yu = Math.ceil(total / limit);
		console.log('yu', yu);
		if(yu > 1) {
			for(var i = 1; i <= yu; i ++){
				if(i == page){
					$('.page').append($('<span class="current">'+ i +'</span>'));
				}else{
					$('.page').append($('<a class="page_click">'+ i +'</a>'));
				}
			}
		}
	}	
}
	
});

 





</script>
</block>